<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
    <style>
        table,
        th,
        td {
            border: 1px solid black;
        }

        #container2 {
            height: calc(100vh - 50px);
            min-height: 800px;
        }

        body {
            height: 100%;
            width: 100%;
            min-height: 700px;
            min-width: 800px;
        }

        .pushable {
            background: hsl(0, 0%, 32%);
            border-radius: 0px;
            border: none;
            padding: 0;
            cursor: pointer;
            outline-offset: 4px;
            border-bottom: 1px solid black;
            border-right: 1px solid black;
        }

        .front {
            display: block;
            padding: 5px 5px;
            border-radius: 0px;
            font-size: 1.25rem;
            background: hsl(217, 86%, 43%);
            color: black;
            border: 1px solid black;
            transform: translateY(-4px) translateX(-2px);
            
        }

        .pushable:active .front {
            transform: translateY(-1px) translateX(-1px);
        }

    </style>
</head>

<body class="bg-gray-200">
    <div class="w-full h-[50px] border-2 border-black flex items-center justify-center relative">
        <div class="font-bold text-xl">Orderbook</div>
        <div class="stats absolute right-4">Throughput: <span id="throughput">0</span> orders/sec</div>
    </div>
    <div class="grid grid-rows-1 grid-cols-3 w-full" id="container2">
        <div class="border-2 border-black row-span-1 col-span-1">
            <div class="h-full overflow-y-auto">
                <table class="w-full">
                    <thead class="sticky top-0 border border-b border-black">
                        <tr>
                            <th class="col-span-1 bg-gray-300 border border-black text-center font-bold">Price</th>
                            <th class="col-span-1 bg-gray-300 border border-black text-center font-bold">Direction</th>
                            <th class="col-span-1 bg-gray-300 border border-black text-center font-bold">Quantity</th>
                            <th class="col-span-1 bg-gray-300 border border-black text-center font-bold">Type</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="border-2 border-black row-span-1 col-span-2 grid grid-rows-6 h-full">
            <div class="row-span-4 border-2 border-black content-center h-full">
                <div id="tester" class="w-full h-full"></div>
            </div>
            <div class="row-span-2 border-2 border-black flex items-center">
                <button class="pushable mx-auto" type="button"><span class="front bg-green-600">Flood Buys</span></button>
                <button class="pushable mx-auto" type="button"><span class="front bg-red-600">Flood Sells</span></button>
                <button class="pushable mx-auto" type="button"><span class="front bg-blue-500">Volume</span></button>
            </div>
        </div>
    </div>
    <script>
            var trace1 = {
                x: [],
                y: [],
                mode: 'lines',
                line: { color: 'rgba(31,119,180,1)' },
                xaxis: 'x',
                yaxis: 'y',
                type: 'scatter'
            };

            var data = [trace1];

            let currentTime = new Date().getTime();
            var layout = {
                dragmode: 'pan',
                paper_bgcolor: "#e5e7eb",
                plot_bgcolor: "#e5e7eb",
                autosize: true,
                margin: {
                    r: 10,
                    t: 25,
                    b: 40,
                    l: 60
                },
                showlegend: false,
                xaxis: {
                    type: 'date',
                    showgrid: false,
                    linewidth: 2,
                    linecolor: 'black',
                    mirror: true
                },
                yaxis: {
                    autorange: true,
                    type: 'linear',
                    linewidth: 2,
                    linecolor: 'black',
                    mirror: true
                }
            };

            var config = {responsive: true}

            Plotly.newPlot('tester', data, layout, config);
            
            let lastFetched = "0";
            let lastFetchedOrders = (new Date()).toISOString();

            setInterval(() => {
                fetch("http://127.0.0.1:8000/orders/?startdate=" + lastFetchedOrders).then(
                    response => {
                        if (!response.ok) {
                            console.log("Network Error")
                        }
                        return response.json()
                    }
                ).then(
                    data => {
                        const tableBody = document.getElementById("orders-table");
                        // tableBody.innerHTML = "";
                        data.forEach(element => {
                            lastFetchedOrders = data[data.length-1].timestamp;
                            const row = document.createElement("tr");
                            const idCell = document.createElement("td");
                            idCell.className = "w-1/4";
                            idCell.innerText = element.price;
                            row.appendChild(idCell);

                            // Order Side (e.g., Buy/Sell) with styling
                            const sideCell = document.createElement("td");
                            sideCell.className = "w-1/4 " + (element.side === 0 ? "text-green-600" : "text-red-600");
                            sideCell.innerText = element.side === 0 ? "Buy" : "Sell";
                            row.appendChild(sideCell);

                            // Quantity
                            const quantityCell = document.createElement("td");
                            quantityCell.className = "w-1/4";
                            quantityCell.innerText = element.quantity;
                            row.appendChild(quantityCell);

                            // Order Type (e.g., Market/Limit)
                            const typeCell = document.createElement("td");
                            typeCell.className = "w-1/4";
                            switch (element.ordertype) {
                                case 0:
                                    typeCell.innerText = "Market";
                                    break;
                                case 1:
                                    typeCell.innerText = "Limit";
                                    break;
                                case 2:
                                    typeCell.innerText = "Fill or Kill";
                                    break;
                                case 3:
                                    typeCell.innerText = "Good Till Cancel";
                                    break;
                                default:
                                    typeCell.innerText = "Unknown";
                            }

                            row.appendChild(typeCell);

                            tableBody.insertBefore(row, tableBody.firstChild);
                        });
                    }
                )
            }, 500);

            setInterval(function () {

                fetch("http://127.0.0.1:8000/price-vol-data/?startdate=" + lastFetched).then(
                    response => {
                        if (!response.ok) {
                            console.log("Network Error")
                        }
                        return response.json()
                    }
                ).then(
                    data => {
                        data.forEach(element => {
                            trace1.x.push(element.timestamp);
                            trace1.y.push(element.price);
                            lastFetched = data[0].timestamp;
                            document.getElementById("throughput").innerText = data[0].volume
                        });
                    }
                )
                const now = lastFetched !== "0" ? new Date(lastFetched) : new Date();
                const startTime = new Date(now.getTime() - 1000 * 60 * 5).toISOString();
                const endTime = new Date(now.getTime() + 10 * 1000).toISOString();


                Plotly.update('tester', {
                    x: [trace1.x],
                    y: [trace1.y]
                });
                Plotly.relayout('tester', {
                    'xaxis.range': [startTime, endTime],
                    'yaxis.autorange': true
                });
            }, 1000);


            window.onresize = function () {
                    Plotly.relayout('tester', {
                        autosize:true
                    },
                );
                };
    </script>
</body>

</html>